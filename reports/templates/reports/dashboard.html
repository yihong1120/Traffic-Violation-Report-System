{% extends "base.html" %}

{% block content %}
  <h2>Welcome, {{ request.user.username }}!</h2>
  <p>This is your dashboard.</p>
  
  <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      
      {# 其他字段的渲染 #}
      {{ form.license_plate.label_tag }}: {{ form.license_plate }}<br>
      {{ form.date.label_tag }}: {{ form.date }}<br>
      {{ form.violation.label_tag }}: {{ form.violation }}<br>
      {{ form.status.label_tag }}: {{ form.status }}<br>
      {{ form.location.label_tag }}: {{ form.location }}<br>
      {{ form.officer.label_tag }}: {{ form.officer }}<br>
      <!-- {{ form.media.label_tag }}: {{ form.media }}<br> -->

      {# 小時和分鐘字段的渲染 #}
      時間: {{ form.hour }} : {{ form.minute }}<br>
      
      {{ form.media.label_tag }}: 
      <input type="file" name="media" multiple id="media-input" style="display: none;">
      <button type="button" id="add-media-button">新增</button><br>
      
      <!-- File Preview Container -->
      <div id="file-preview-container"></div>

      <button type="submit">提交</button>
  </form>

  <!-- Google Maps Embed -->
  <div id="map-container" style="height: 400px; width: 100%;">
    <iframe
        width="100%"
        height="100%"
        frameborder="0" style="border:0"
        api_key = settings.GOOGLE_MAPS_API_KEY  # 确保在settings.py中定义了这个变量
        src="https://www.google.com/maps/embed/v1/view?key=YOUR_API_KEY&center=23.6978,120.9605&zoom=8&maptype=roadmap" allowfullscreen>
    </iframe>
  </div>

  <script>
    var customFileList = []; // Custom file list
    document.getElementById('add-media-button').addEventListener('click', function() {
      document.getElementById('media-input').click();
    });

    document.getElementById('media-input').addEventListener('change', function(e) {
      Array.from(e.target.files).forEach(file => {
        customFileList.push(file);
        createPreview(file);
      });
      updateFormFiles();
    });

    function createPreview(file) {
      let previewContainer = document.getElementById('file-preview-container');
      let previewDiv = document.createElement('div');
      previewDiv.classList.add('file-preview');
      previewDiv.dataset.fileName = file.name;

      let removeButton = document.createElement('button');
      removeButton.innerText = 'X';
      removeButton.classList.add('remove-button');
      removeButton.onclick = function() {
        removeFile(file.name);
        previewDiv.remove();
      };

      let image = new Image();
      image.height = 100;
      image.title = file.name;
      let reader = new FileReader();
      reader.onload = function(e) {
        image.src = e.target.result;
      };
      reader.readAsDataURL(file);

      previewDiv.appendChild(image);
      previewDiv.appendChild(removeButton);
      previewContainer.appendChild(previewDiv);
    }

    function removeFile(fileName) {
      customFileList = customFileList.filter(file => file.name !== fileName);
      updateFormFiles();
    }

    function updateFormFiles() {
      let dataTransfer = new DataTransfer();
      customFileList.forEach(file => dataTransfer.items.add(file));
      document.getElementById('media-input').files = dataTransfer.files;
    }
  </script>

  <style>
    #file-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .file-preview {
      position: relative;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      margin: 5px;
    }
    .file-preview img {
      display: block;
    }
    .file-preview .remove-button {
      position: absolute;
      top: -10px;  /* Adjust as needed */
      right: -10px; /* Adjust as needed */
      background-color: red;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 50%;
      padding: 0 5px;
    }
  </style>
{% endblock %}
