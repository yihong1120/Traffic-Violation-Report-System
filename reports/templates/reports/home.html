{% extends "base.html" %}

{% block content %}
<h2>Welcome to Traffic Violation Report System</h2>

{% if request.user.is_authenticated %}
    <p>Hello, {{ request.user.username }}!</p>
    <a href="{% url 'logout' %}">Logout</a>
{% else %}
    <p>Please <a href="{% url 'login' %}">login</a> to continue.</p>
{% endif %}

<div id="map-container" style="height: 400px; width: 100%;">
    <div id="map" style="height: 100%;"></div>
</div>

<script>
    function initMap() {
        var map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: 23.6978, lng: 120.9605},
            zoom: 8,
            mapTypeId: 'roadmap'
        });

        fetch('/traffic-violations/')
        .then(response => response.json())
        .then(data => {
            data.forEach(function(item) {
                var marker = new google.maps.Marker({
                    position: {lat: item.lat, lng: item.lng},
                    map: map,
                    title: item.title
                });

                var imageSrc = item.media ? '/' + item.media : getRandomErrorImage();
                var infowindowContent = '<div><strong>' + item.title + '</strong><br>' +
                                        '<img src="' + imageSrc + '" style="width: 150px;" onerror="this.onerror=null;this.src=getRandomErrorImage();"><br>' +
                                        '其他信息或描述</div>';

                var infowindow = new google.maps.InfoWindow({
                    content: infowindowContent
                });

                marker.addListener('click', function() {
                    infowindow.open(map, marker);
                });
            });
        });
    }
</script>



<!-- 引入 Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap" async defer></script>

{% endblock %}